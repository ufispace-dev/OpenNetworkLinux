#!/bin/bash

if [ -z "${UFI_UG_PATH}" ]; then
    export UFI_UG_PATH=$(pwd) 
fi

VER="0.0.2-bsp"

function _get_i2c_root {

    i801_bus="-1"
    ismt_bus="-1"
    if [ -f "/sys/bus/i2c/devices/i2c-0/name" ]; then
        i2c_root=`cat /sys/bus/i2c/devices/i2c-0/name`
    fi

    if echo "$i2c_root" | grep -q "I801"; then
        i801_bus="0"
    fi

    if echo "$i2c_root" | grep -q "iSMT"; then
        ismt_bus="0"
    fi

    if [ -f "/sys/bus/i2c/devices/i2c-1/name" ]; then
        i2c_root=`cat /sys/bus/i2c/devices/i2c-1/name`
    fi

    if echo "$i2c_root" | grep -q "I801"; then
        i801_bus="1"
    fi

    if echo "$i2c_root" | grep -q "iSMT"; then
        ismt_bus="1"
    fi

    if [ "$ismt_bus" = "-1" ]; then
        echo "Not supported"
        exit -1
    fi
}

bus_num_check()
{
    set_value=${1}
    if [ -f "/sys/devices/platform/x86_64_ufispace_s9510_30xc_lpc/bsp/bsp_version" ]; then
        #printf "SYSFS exists, skip to set i2c mux...\n"
        i2c_bus_f="-f 4"
    else
        i2cset -y ${ismt_bus} 0x75 ${set_value}
        i2c_bus_f="${ismt_bus}"
    fi
}

function _ioget {
    reg=$1
    echo "0x"`dd if=/dev/port bs=1 count=1 skip=$((reg)) status=none | xxd -g 1 | cut -d ' ' -f 2`
}

function _ioset {
    local reg=$1
    local val=$(printf "%02x" $(($2)))
    printf "\x${val}" | dd of="/dev/port" bs=1 seek=$((reg)) count=1 conv=notrunc 2>/dev/null
}

check_board_bits_type()
{   
    cpld_sku_type_reg=0x701
    reg_value=`_ioget $cpld_sku_type_reg | awk -F' ' '{print $NF}'`
    # bit 5
    sku_8bit_value=$(($reg_value & 0x20))
    sku_8bit_type=$(($sku_8bit_value >> 5))
}

check_boardid_hwrev()
{   
    #0: SKU ID Types, 4bit
    #1: SKU ID Types, 8bit
    if [ ${sku_8bit_type} -eq 1 ]; then

        cpld_skuid_value=$(_ioget 0x700 | awk -F" " {'print $NF'})
        cpld_hw_rev_value=$(_ioget 0x701 | awk -F" " {'print $NF'})

        #check board id value
        if [ "$((cpld_skuid_value & 0xff))" == 254 ]; then
            HW_PLAT="HAWKEYE"
        else
            HW_PLAT="NA"
        fi

        #check hw rev value
        if [ "$((cpld_hw_rev_value & 0x03))" == 0 ]; then
            HW_REV="PROTO"
        elif [ "$((cpld_hw_rev_value & 0x03))" == 1 ]; then
            HW_REV="ALPHA"
        elif [ "$((cpld_hw_rev_value & 0x03))" == 2 ]; then
            HW_REV="BETA"
        else
            HW_REV="PVT"
        fi

        #check build rev value
        if [ "$((cpld_hw_rev_value & 0x18))" == 0 ]; then
            BUILD_REV="ONE"
        elif [ "$((cpld_hw_rev_value & 0x18))" == 8 ]; then
            BUILD_REV="TWO"
        elif [ "$((cpld_hw_rev_value & 0x18))" == 16 ]; then
            BUILD_REV="THREE"
        else
            BUILD_REV="FOUR"
        fi
    else
        #enable i2c mux 0x75, ch2
        _get_i2c_root
        if [ -n "$(i2cget -f -y ${ismt_bus} 0x75 2>&1 | grep 'Error')" ]; then
            echo "No i2c mux 0x75, Alpha"
            HW_REV="ALPHA"
        else
            bus_num_check "0x4"
            sleep 0.3
            #check if ioexp(0x20) exist or not
            i2cget -y ${i2c_bus_f} 0x20 0 > /dev/null
            if [ $? -ne 0 ]; then
                echo "IOEXP 0x20 doesn't exist"
                HW_REV="ALPHA"
            else
                sleep 0.3
                #Configure 0x20 ioexp default value
                i2cset -y ${i2c_bus_f} 0x20 0x4 0x0
                i2cset -y ${i2c_bus_f} 0x20 0x5 0x0
                i2cset -y ${i2c_bus_f} 0x20 0x6 0xff
                i2cset -y ${i2c_bus_f} 0x20 0x7 0xff

                #check hw rev value
                hw_rev_value=`i2cget -y ${i2c_bus_f} 0x20 0x1`
                if [ "$((hw_rev_value & 0xC))" == 12 ]; then
                    HW_REV="PVT"
                elif [ "$((hw_rev_value & 0x8))" == 8 ]; then
                    HW_REV="ALPHA"
                elif [ "$((hw_rev_value & 0x4))" == 4 ]; then
                    HW_REV="BETA"
                else
                    HW_REV="PROTO"
                fi

                #check board id value
                if [ "$((hw_rev_value & 0xf0))" == "$((16#10))" ]; then
                    HW_PLAT="QAX"
                elif [ "$((hw_rev_value & 0xf0))" == "$((16#00))"  ]; then
                    HW_PLAT="QAX-Lite"
                elif [ "$((hw_rev_value & 0xf0))" == "$((16#20))"  ]; then
                    HW_PLAT="QAX-NTM"
                elif [ "$((hw_rev_value & 0xf0))" == "$((16#30))"  ]; then
                    HW_PLAT="QUX-FS"
                elif [ "$((hw_rev_value & 0xf0))" == "$((16#40))"  ]; then
                    HW_PLAT="QUX-HB"
                elif [ "$((hw_rev_value & 0xf0))" == "$((16#50))"  ]; then
                    HW_PLAT="Q2A"
                elif [ "$((hw_rev_value & 0xf0))" == "$((16#60))"  ]; then
                    HW_PLAT="Q2U"
                else
                    HW_PLAT="NA"
                fi

                #check build rev value
                if [ "$((hw_rev_value & 0x3))" == 3 ]; then
                    BUILD_REV="FOUR"
                elif [ "$((hw_rev_value & 0x3))" == 1 ]; then
                    BUILD_REV="THREE"
                elif [ "$((hw_rev_value & 0x3))" == 2 ]; then
                    BUILD_REV="TWO"
                else
                    BUILD_REV="ONE"
                fi
            fi
        fi

        #close the i2c mux
        bus_num_check "0x0"
    fi
    echo $HW_PLAT
    echo $HW_REV
    echo $BUILD_REV
}

help()
{
    echo ""
    echo "========================================================================================================"
    echo "                                      - Reset mac command -(Version ${VER})"
    echo "========================================================================================================"
    echo "option:"
    echo "  ${0} <device> [<loop>]"
    echo "      - To reset mac"
    echo "      device: Specify the chip to reset. Valid values is mac"
    echo "      loop  : Test cycles, default is 1"
    echo "usage:"
    echo "  e.g. ${0} mac 3"
    echo ""
}

get_mac_info()
{
    case "${HW_PLAT}" in
    "Q2A"|"Q2U")
        lspci -vvv -s $(setpci -s 00:0e.0 0x19.b):00.0 >> /tmp/mac_info 2>&1
        ;;
    *)
        echo "unknown platform"
        ;;
    esac

}

del_exist_log()
{
    if [ -f "/tmp/mac_info" ]; then
        rm /tmp/mac_info
    fi 
}

pre_check()
{
    case ${1} in
    mac)
        case "${HW_PLAT}" in
        "Q2A")
            mac_id=`lspci | grep "848[0-9]" | head -1 | awk '{print $7}'`
            expected_mac_number=1  
            ;;
        "Q2U")
            mac_id=`lspci | grep "828[0-9]" | head -1 | awk '{print $7}'`
            expected_mac_number=1
            ;;
        *)
            echo "unknown platform"
            exit 2
            ;;
        esac

        mac_cnt=`lspci | grep ${mac_id} | wc -l`
        if [ ${mac_cnt} -ne ${expected_mac_number} ]; then
            lspci | ${mac_id}
            echo "Error message : Before test, ${expected_mac_number} MAC should be exist! ( pre_check fail )"
            echo "resetchip - FAIL"
            exit 2
        fi
        ;;
    *)
        echo "Invalid Parameters"
        exit 1
        ;;
    esac
}

get_pcie_status()
{
    case ${1} in
    mac)
        echo "RP Status 00:0e.0"
        lspci -vvv -s 00:0e.0 | grep -e 'DevSta:' -e 'LnkSta:' -e 'UESta:' -e 'CESta:' -e 'SERR'
        printf "MAC Status %s:00.0:\n" $(setpci -s 00:0e.0 0x19.b)
        case "${HW_PLAT}" in
        "Q2A"|"Q2U")
            lspci -vvv -s $(setpci -s 00:0e.0 0x19.b):00.0 | grep -e 'DevSta:' -e 'LnkSta:' -e 'UESta:' -e 'CESta:' -e 'SERR' 
            ;;

        *)
            echo "unknown platform"
            ;;
        esac      
        ;;
    
    *)
        echo "Invalid Parameters"
        help
        ;;
    esac
}

verify_pcie_status()
{
    pcie_error=0
    case ${1} in
    mac)
        case "${HW_PLAT}" in
        "Q2A"|"Q2U")
            # RP
            out=`lspci -vvv -s 00:0e.0 | grep -e 'DevSta:' | grep -e 'UncorrErr+' -e 'FatalErr+'`
            if [ "${out}" != "" ]; then
                pcie_error=1
            fi
            out=`lspci -vvv -s 00:0e.0 | grep -e 'LnkSta:' | grep 'Speed' | grep 'Width'`
            if [ "${out}" == "" ]; then
                pcie_error=1   
            fi
            out=`lspci -vvv -s 00:0e.0 | grep -e 'UESta:' | grep -e 'DLP+' -e 'SDES+' -e 'TLP+' -e 'FCP+' -e 'CmpltTO+' -e 'CmpltAbrt+' -e 'UnxCmplt+' -e 'RxOF+' -e 'MalfTLP+' -e 'ECRC+' -e 'ACSViol+'`
            if [ "${out}" != "" ]; then
                pcie_error=1
            fi
            out=`lspci -vvv -s 00:0e.0 | grep -e 'CESta:' | grep -e 'RxErr+' -e 'BadTLP+' -e 'BadDLLP+' -e 'Rollover+' -e 'Timeout+'`
            if [ "${out}" != "" ]; then
                pcie_error=1
            fi
            # MAC
            out=`lspci -vvv -s $(setpci -s 00:0e.0 0x19.b):00.0 | grep -e 'DevSta:' | grep -e 'UncorrErr+' -e 'FatalErr+'`
            if [ "${out}" != "" ]; then
                pcie_error=1
            fi
            out=`lspci -vvv -s $(setpci -s 00:0e.0 0x19.b):00.0 | grep -e 'LnkSta:' | grep 'Speed' | grep 'Width'`
            if [ "${out}" == "" ]; then
                pcie_error=1
            fi
            out=`lspci -vvv -s $(setpci -s 00:0e.0 0x19.b):00.0 | grep -e 'UESta:' | grep -e 'DLP+' -e 'SDES+' -e 'TLP+' -e 'FCP+' -e 'CmpltTO+' -e 'CmpltAbrt+' -e 'UnxCmplt+' -e 'RxOF+' -e 'MalfTLP+' -e 'ECRC+' -e 'ACSViol+'`
            if [ "${out}" != "" ]; then
                pcie_error=1
            fi
            out=`lspci -vvv -s $(setpci -s 00:0e.0 0x19.b):00.0 | grep -e 'CESta:' | grep -e 'RxErr+' -e 'BadTLP+' -e 'BadDLLP+' -e 'Rollover+' -e 'Timeout+'`
            if [ "${out}" != "" ]; then
                pcie_error=1
            fi
            ;;
        
        *)
            echo "unknown platform"
            ;;
        esac      
        ;;
    
    *)
        ;;
    esac
}

remove_kmod()
{
    case ${1} in
    mac)
        kmod_cnt=`lsmod | grep bde | wc -l`
        if [ ${kmod_cnt} -eq 2 ]; then
            rmmod linux_user_bde
            rmmod linux_kernel_bde
        fi
        ;;
    *)
        echo "Invalid Parameters"
        help
        ;;
    esac
}

remove_dev()
{
    case ${1} in
    mac)
        if [ -d /sys/bus/pci/devices/0000\:$(setpci -s 00:0e.0 0x19.b)\:00.0 ]; then
            echo 1 > /sys/bus/pci/devices/0000\:$(setpci -s 00:0e.0 0x19.b)\:00.0/remove
        fi
        if [ -d /sys/bus/pci/devices/0000\:$(setpci -s 00:0e.0 0x19.b)\:00.1 ]; then
            echo 1 > /sys/bus/pci/devices/0000\:$(setpci -s 00:0e.0 0x19.b)\:00.1/remove
        fi
        sleep 1
        ;;
    *)
        echo "Invalid Parameters"
        help
        ;;
    esac
}

set_2nd_bus_reset()
{
    case ${1} in
    mac)
        bc=$(setpci -s 00:0e.0 BRIDGE_CONTROL)
        if [ ${2} -eq 1 ]; then
            setpci -s 00:0e.0 BRIDGE_CONTROL=$(printf "%04x" $(("0x$bc" | 0x40)))
        else
            setpci -s 00:0e.0 BRIDGE_CONTROL=$(printf "%04x" $(("0x$bc" & 0xBF)))
        fi
        sleep 1
        ;;
    *)
        echo "Invalid Parameters"
        exit 1
        ;;
    esac
}

set_dev_reset()
{
    case ${1} in
    mac)
        case "${HW_PLAT}" in
        "Q2A"|"Q2U")
            val=$(_ioget 0x742 | awk -F' ' '{print $NF}')
            sleep 0.1
            if [ ${2} -eq 1 ]; then
                _ioset 0x742 $(printf "0x%02x" $(("$val" & 0xfc)))
            else
                _ioset 0x742 $(printf "0x%02x" $(("$val" | 0xff)))
            fi
            sleep 2
            ;;
        *)
            echo "unknown platform"
            ;;
        esac
        ;;
        
    *)
        echo "Invalid Parameters"
        exit 1
        ;;
    esac
}

rescan_pcie_dev()
{
    case ${1} in
    mac)
        echo 1 > /sys/bus/pci/rescan
        sleep 1
        ;;

    *)
        echo "Invalid Parameters"
        exit 1
        ;;
    esac
}

reset_mac()
{
    max=${1}
    cnt=0
    while [ ${cnt} -lt ${max} ]
    do
        echo "Reset MAC Test (${cnt})..."
        echo "============================================================"

        pre_check mac

        remove_kmod mac
        
        echo "Before Warm Reset......"
        get_pcie_status mac 
        
        printf "Remove MAC......"
        remove_dev mac 
        printf "done\n"
        
        # set secondary bus reset to 1 before MAC reset
        printf "Set SBR......"
        set_2nd_bus_reset mac 1
        printf "done\n"
        
        # reset MAC (PCIe)
        printf "Reset MAC......"
        set_dev_reset mac 1
        printf "done\n"

        # unreset MAC (PCIe)
        printf "Unreset MAC......"
        set_dev_reset mac 0
        printf "done\n"
        
        # set secondary bus reset to 0 after MAC reset
        printf "Unset SBR......"
        set_2nd_bus_reset mac 0
        printf "done\n"
        
        # rescan PCIe Bus
        printf "Rescan PCIe for MACs......"
        rescan_pcie_dev mac 
        printf "done\n"
        
        printf "Check MAC Quantity......"
        #mac id from pre_check mac
        mac_cnt=`lspci | grep ${mac_id} | wc -l`

        if [ ${mac_cnt} -ne ${expected_mac_number} ]; then
            printf "%d, fail\n" ${mac_cnt}
            echo "============================================================"
            lspci | grep ${mac_id}
            echo "Error message : After reset, ${expected_mac_number} MACs should be exist!"
            echo "resetchip - FAIL"
            exit 2
        fi
        printf "%d, done\n" ${mac_cnt}

        printf "Check RP & Device Status......"
        verify_pcie_status mac
        if [ ${pcie_error} -ne 0 ]; then
            printf "fail\n"
            echo "============================================================"
            get_pcie_status mac 
            echo "Error message : After reset, MAC or RP status abnormal!"
            echo "resetchip - FAIL"
            exit 2
        fi
        printf "done\n"

        echo "After Warm Reset......"
        get_pcie_status mac 
        
        echo "============================================================"

        cnt=$((cnt+1))
    done

    echo "resetchip - PASS"
}

main()
{   
    case ${1} in
    "mac")
        loop=1
        if [ "$#" -eq 2 ]; then
            loop=${2}
        fi
        echo "Test Parameters: loop - ${loop}"
        reset_mac ${loop}
        ;;

    "help")
        help
        ;;

    *)
        echo ""
        echo "Invalid parameters"
        help
        exit 1
        ;;
    esac
}

#### Check SKU ID bits Types 
check_board_bits_type

##### The below function should retrieve $HW_REV and $HW_PLAT
check_boardid_hwrev

main ${1} ${2} ${3} ${4} ${5} ${6} ${7} ${8} ${9} ${10}

exit 0
