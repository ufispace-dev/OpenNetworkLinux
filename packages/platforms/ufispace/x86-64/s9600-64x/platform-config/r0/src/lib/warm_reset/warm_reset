#!/bin/bash

### bsp
VER="0.0.1-bsp"

bus_num_check()
{
    set_value=${1}
    if [ -f "/sys/bus/i2c/devices/1-0030/cpld_id" ]; then
        #printf "SYSFS exists, skip to set i2c mux...\n"
        i2c_bus_f="-f 1"
    else
        i2cset -y 0 0x75 ${set_value}
        i2c_bus_f="0"
    fi
}

function _ioget {
    reg=$1
    echo "0x"`dd if=/dev/port bs=1 count=1 skip=$((reg)) status=none | xxd -g 1 | cut -d ' ' -f 2`
}

function _ioset {
    local reg=$1
    local val=$(printf "%02x" $(($2)))
    printf "\x${val}" | dd of="/dev/port" bs=1 seek=$((reg)) count=1 conv=notrunc 2>/dev/null
}

show_ver()
{
    echo "== Utility for reset operation (Version ${VER}) =="
}

### bsp

if [ -z "${UFI_RESET_TOOL_PATH}" ]; then
    #echo "Please set UFI_RESET_TOOL_PATH"
    #exit 1
    export UFI_RESET_TOOL_PATH=$(pwd)
fi

silence=0

help()
{
    echo ""
    echo "== Utility for reset operation (Version ${VER}) =="
    echo "Format: ${0} <target|help|version> [<silent>]"
    echo "  target:"
    echo "    mac  : Reset MAC"
    echo "    phy  : Reset BCM81381"
    echo "    all  : Reset MAC and BCM81381"
    echo "  version: Show script version"
    echo "  silent(optional): Don't display reset result"
    echo ""
}

print_log()
{
    if [ ${silence} -ne 1 ]; then
        printf "${1}"
    fi
}

board_id_get()
{
  value=$((${1} & 0xFF))

  case $value in
    "12")
      BOARD_NAME="s9600-64x"
      ;;
    "13")
      BOARD_NAME="s9600-32x"
      ;;
    *)
      BOARD_NAME="Unknown"
      ;;
  esac
}

check_board_info()
{
  #enable i2c mux 0x75, ch0
  #if [ -n "$(i2cset -y 0 0x75 0x1  2>&1 | grep 'Error')" ]; then
  #check i2c mux 0x75 exist
  if [ -n "$(i2cget -f -y 0 0x75 2>&1 | grep 'Error')" ]; then
    echo "No i2c mux 0x75, default Alpha"
    HW_REV="ALPHA"
    BUILD_REV=0
  else
    bus_num_check "0x1"
    sleep 0.3
    #check if cpld0(0x30) reg(0x0) exist or not
    #i2cget -y 0 0x30 0x0 > /dev/null
    i2cget -y ${i2c_bus_f} 0x30 0x0 > /dev/null
    if [ $? -ne 0 ]; then
      echo "CPLD0 doesn't exist"
      HW_REV="ALPHA"
      BUILD_REV=0
    else
      sleep 0.3
      #check board id value
      #BOARD_ID=`i2cget -y 0 0x30 0x0`
      BOARD_ID=`i2cget -y ${i2c_bus_f} 0x30 0x0`

      #Board ID
      board_id_get ${BOARD_ID}
    fi
    bus_num_check "0x0"
  fi
}

get_pcie_status()
{
    case "${1}" in
    "mac")
        if [ "$BOARD_NAME" == "s9600-64x" ]; then
            echo "RP Status 16:00.0:"
            lspci -vvv -s 16:00.0 | grep -e DevSta: -e LnkSta: -e UESta: -e CESta: -e SERR
            printf "MAC(R) Status %s:00.0:\n" $(setpci -s 16:00.0 0x19.b)
            lspci -vvv -s $(setpci -s 16:00.0 0x19.b):00.0 | grep -e DevSta: -e LnkSta: -e UESta: -e CESta: -e SERR
        fi

        echo "RP Status 64:03.0:"
        lspci -vvv -s 64:03.0 | grep -e DevSta: -e LnkSta: -e UESta: -e CESta: -e SERR
        printf "MAC(L) Status %s:00.0:\n" $(setpci -s 64:03.0 0x19.b)
        lspci -vvv -s $(setpci -s 64:03.0 0x19.b):00.0 | grep -e DevSta: -e LnkSta: -e UESta: -e CESta: -e SERR
        ;;
    *)
        echo "Invalid Parameters"
        help
        ;;
    esac
}

remove_kmod()
{
    case "${1}" in
    "mac")
        kmod_cnt=`lsmod | grep bde | wc -l`
        if [ ${kmod_cnt} -eq 2 ]; then
            rmmod linux_user_bde
            rmmod linux_kernel_bde
        fi
        ;;
    *)
        print_log "Invalid Parameters\n"
        help
        ;;
    esac
}

remove_dev()
{
    case "${1}" in
    "mac")
        if [ "$BOARD_NAME" == "s9600-64x" ]; then
            echo 1 > /sys/bus/pci/devices/0000\:$(setpci -s 16:00.0 0x19.b)\:00.0/remove
        fi
        echo 1 > /sys/bus/pci/devices/0000\:$(setpci -s 64:03.0 0x19.b)\:00.0/remove
        sleep 1
        ;;
    *)
        print_log "Invalid Parameters\n"
        help
        ;;
    esac
}

set_2nd_bus_reset()
{
    case "${1}" in
    "mac")
        if [ ${2} -eq 1 ]; then
            if [ "$BOARD_NAME" == "s9600-64x" ]; then
                #setpci -s 16:00.0 0x3e.b
                #sleep 0.1
                bc=$(setpci -s 16:00.0 BRIDGE_CONTROL)
                setpci -s 16:00.0 BRIDGE_CONTROL=$(printf "%04x" $(("0x$bc" | 0x40)))
                sleep 0.1
            fi

            #setpci -s 64:03.0 0x3e.b
            #sleep 0.1
            bc=$(setpci -s 64:03.0 BRIDGE_CONTROL)
            setpci -s 64:03.0 BRIDGE_CONTROL=$(printf "%04x" $(("0x$bc" | 0x40)))
            sleep 1
        else
            if [ "$BOARD_NAME" == "s9600-64x" ]; then
                #setpci -s 16:00.0 0x3e.b
                #sleep 0.1
                bc=$(setpci -s 16:00.0 BRIDGE_CONTROL)
                setpci -s 16:00.0 BRIDGE_CONTROL=$(printf "%04x" $(("0x$bc" & 0xBF)))
                sleep 0.1
            fi

            #setpci -s 64:03.0 0x3e.b
            #sleep 0.1
            bc=$(setpci -s 64:03.0 BRIDGE_CONTROL)
            setpci -s 64:03.0 BRIDGE_CONTROL=$(printf "%04x" $(("0x$bc" & 0xBF)))
            sleep 1
        fi
        ;;
    *)
        print_log "Invalid Parameters\n"
        exit 1
        ;;
    esac
}

reset_mac()
{
    print_log "Reset MAC...\n"
    print_log "==============================\n"

    print_log "Before MAC Warm Reset ...\n"
    get_pcie_status mac

    remove_kmod mac

    print_log "Remove MAC from PCIe bus......"
    remove_dev mac
    sleep 1
    print_log "done\n"

    # set secondary bus reset to 1 before MAC reset
    set_2nd_bus_reset mac 1

    # reset MAC
    if [ "$BOARD_NAME" == "s9600-64x" ]; then
        mac_rst_val=0xFC
        mac_nol_val=0x03
    else
        mac_rst_val=0xFD
        mac_nol_val=0x02
    fi

    print_log "Reset Assertion......"
    #val=$(ioget 0xe21 | awk -F' ' '{print $NF}')
    val=$(_ioget 0xe21)
    sleep 0.1
    #ioset 0xe21 $(printf "0x%02x" $(("$val" & "$mac_rst_val")))
    _ioset 0xe21 $(printf "0x%02x" $(("$val" & "$mac_rst_val")))
    sleep 2
    print_log "done\n"

    # unreset MAC
    print_log "Reset Deassertion......"
    #val=$(ioget 0xe21 | awk -F' ' '{print $NF}')
    val=$(_ioget 0xe21)
    sleep 0.1
    #ioset 0xe21 $(printf "0x%02x" $(("$val" | "$mac_nol_val")))
    _ioset 0xe21 $(printf "0x%02x" $(("$val" | "$mac_nol_val")))
    sleep 2
    print_log "done\n"

    # set secondary bus reset to 0 after MAC reset
    set_2nd_bus_reset mac 0

    print_log "Rescan PCIe bus......"
    echo 1 > /sys/bus/pci/rescan
    sleep 1
    print_log "done\n"

    print_log "Check MAC status......"

    if [ "$BOARD_NAME" == "s9600-64x" ]; then
        exp_mac_cnt=2
    else
        exp_mac_cnt=1
    fi

    mac_cnt=`lspci | grep 8820 | wc -l`
    if [ ${mac_cnt} -ne ${exp_mac_cnt} ]; then
        print_log "fail: After reset, ${exp_mac_cnt} MACs should be exist!\n"
        lspci | grep 8820
        exit 2
    else
        print_log "done\n"
    fi

    print_log "After MAC Warm Reset ...\n"
    get_pcie_status mac

    print_log "==============================\n"
    print_log "Reset MAC Done\n\n"
}


reset_phy()
{
    print_log "Reset BCM81381...\n"
    print_log "==============================\n"

    # reset BCM81381
    print_log "Reset Assertion......"
    #val=$(ioget 0xe21 | awk -F' ' '{print $NF}')
    val=$(_ioget 0xe21)
    sleep 0.1
    #ioset 0xe21 $(printf "0x%02x" $(("$val" & 0xF3)))
    _ioset 0xe21 $(printf "0x%02x" $(("$val" & 0xF3)))
    sleep 2
    print_log "done\n"

    # unreset BCM81381
    print_log "Reset Deassertion......"
    #val=$(ioget 0xe21 | awk -F' ' '{print $NF}')
    val=$(_ioget 0xe21)
    sleep 0.1
    #ioset 0xe21 $(printf "0x%02x" $(("$val" | 0x0C)))
    _ioset 0xe21 $(printf "0x%02x" $(("$val" | 0x0C)))
    sleep 2
    print_log "done\n"

    print_log "==============================\n"
    print_log "Reset BCM81381 Done\n\n"
}

main()
{
    check_board_info

    echo "$BOARD_NAME"

    case ${2} in
    1)
        silence=1
        ;;
    *)
        silence=0
        ;;
    esac

    case ${1} in
    "mac")
        reset_mac
        ;;
    "phy")
        reset_phy
        ;;
    "all")
        reset_phy
        sleep 1
        reset_mac
        sleep 1
        ;;
    "help")
        help
        ;;
    *)
        print_log "\n"
        print_log "Invalid parameters"
        help
        exit 1
        ;;
    esac
}

main ${1} ${2} ${3} ${4} ${5} ${6} ${7} ${8} ${9} ${10}

exit 0
